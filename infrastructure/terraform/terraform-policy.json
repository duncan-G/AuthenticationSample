{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "EC2FullAccess",
      "Effect": "Allow",
      "Action": [
        "ec2:*"
      ],
      "Resource": "*"
    },
    {
      "Sid": "SSMParameterManagement",
      "Effect": "Allow",
      "Action": [
        "ssm:*"
      ],
      "Resource": [
        "arn:aws:ssm:*:*:parameter/docker/swarm/*",
        "arn:aws:ssm:*:*:document/${PROJECT_NAME}-*",
        "arn:aws:ssm:*:*:parameter/swarm/*"
      ]
    },
    {
      "Sid": "SSMDiscovery",
      "Effect": "Allow",
      "Action": [
        "ssm:DescribeParameters",
        "ssm:GetParametersByPath"
      ],
      "Resource": "*"
    },
    {
      "Sid": "IAMForInstanceRoles",
      "Effect": "Allow",
      "Action": [
        "iam:Create*",
        "iam:Delete*",
        "iam:Tag*",
        "iam:Untag*",
        "iam:Get*",
        "iam:List*",
        "iam:Put*",
        "iam:Attach*",
        "iam:Detach*",
        "iam:AddRoleToInstanceProfile",
        "iam:RemoveRoleFromInstanceProfile"
      ],
      "Resource": [
        "arn:aws:iam::*:role/${PROJECT_NAME}-*",
        "arn:aws:iam::*:policy/${PROJECT_NAME}-*",
        "arn:aws:iam::*:instance-profile/${PROJECT_NAME}-*",
        "arn:aws:iam::*:oidc-provider/token.actions.githubusercontent.com"
      ]
    },
    {
      "Sid": "PassRoleConstraint",
      "Effect": "Allow",
      "Action": "iam:PassRole",
      "Resource": [
        "arn:aws:iam::${AWS_ACCOUNT_ID}:role/${PROJECT_NAME}-*"
      ],
      "Condition": {
        "StringEquals": {
          "iam:PassedToService": [
            "ec2.amazonaws.com",
            "codedeploy.amazonaws.com"
          ]
        }
      }
    },
    {
      "Sid": "STSRead",
      "Effect": "Allow",
      "Action": "sts:GetCallerIdentity",
      "Resource": "*"
    },
    {
      "Sid": "S3BucketPermissions",
      "Effect": "Allow",
      "Action": [
        "s3:Get*",
        "s3:ListBucket",
        "s3:CreateBucket",
        "s3:PutObject",
        "s3:DeleteObject",
        "s3:PutBucketVersioning",
        "s3:PutBucketTagging",
        "s3:PutBucketPublicAccessBlock"
      ],
      "Resource": [
        "arn:aws:s3:::${TF_STATE_BUCKET}",
        "arn:aws:s3:::${TF_STATE_BUCKET}/*",
        "arn:aws:s3:::${DEPLOYMENT_BUCKET}",
        "arn:aws:s3:::${DEPLOYMENT_BUCKET}/*"
      ]
    },
    {
      "Sid": "CodeDeployPermissions",
      "Effect": "Allow",
      "Action": [
        "codedeploy:*"
      ],
      "Resource": "*"
    },
    {
      "Sid": "CloudWatchLogsPermissions",
      "Effect": "Allow",
      "Action": [
        "logs:*"
      ],
      "Resource": "*"
    },
    {
      "Sid": "Route53Permissions",
      "Effect": "Allow",
      "Action": [
        "route53:*"
      ],
      "Resource": "*"
    },
    {
      "Sid": "ECRPermissions",
      "Effect": "Allow",
      "Action": [
        "ecr:*"
      ],
      "Resource": [
        "arn:aws:ecr:*:${AWS_ACCOUNT_ID}:repository/${PROJECT_NAME}/*"
      ]
    },
    {
      "Sid": "SSOAdminPermissions",
      "Effect": "Allow",
      "Action": [
        "sso:*"
      ],
      "Resource": "*"
    },
    {
      "Sid": "SSOIdentityStoreGroupPermissions",
      "Effect": "Allow",
      "Action": [
        "identitystore:*"
      ],
      "Resource": "*"
    },
    {
      "Sid": "SSOIAMPermissions",
      "Effect": "Allow",
      "Action": [
        "iam:GetRole",
        "iam:ListRoles",
        "iam:ListRolePolicies",
        "iam:GetRolePolicy",
        "iam:ListAttachedRolePolicies"
      ],
      "Resource": [
        "arn:aws:iam::*:role/AWSReservedSSO_*",
        "arn:aws:iam::*:role/aws-reserved/sso.amazonaws.com/*"
      ]
    },
    {
      "Sid": "SecretsManagerPermissions",
      "Effect": "Allow",
      "Action": [
        "secretsmanager:*"
      ],
      "Resource": [
        "arn:aws:secretsmanager:*:${AWS_ACCOUNT_ID}:secret:${PROJECT_NAME}-secrets-development*"
      ]
    },
    {
      "Sid": "CognitoPermissions",
      "Effect": "Allow",
      "Action": [
        "cognito-idp:*",
        "cognito-identity:*"
      ],
      "Resource": [
        "arn:aws:cognito-idp:*:${AWS_ACCOUNT_ID}:userpool/*",
        "arn:aws:cognito-identity:*:${AWS_ACCOUNT_ID}:identitypool/*"
      ]
    },
    {
      "Sid": "ACMCertificateManagerPermissions",
      "Effect": "Allow",
      "Action": [
        "acm:RequestCertificate",
        "acm:DescribeCertificate",
        "acm:ListCertificates",
        "acm:DeleteCertificate",
        "acm:AddTagsToCertificate",
        "acm:RemoveTagsFromCertificate",
        "acm:ListTagsForCertificate",
        "acm:UpdateCertificateOptions"
      ],
      "Resource": "*"
    },
    {
      "Sid": "Route53ChangeRecordPermissions",
      "Effect": "Allow",
      "Action": [
        "route53:ChangeResourceRecordSets",
        "route53:ListResourceRecordSets"
      ],
      "Resource": "*"
    }
    ,
    {
      "Sid": "SESDomainVerificationPermissions",
      "Effect": "Allow",
      "Action": [
        "ses:*"
      ],
      "Resource": "*"
    }
    ,
    {
      "Sid": "CloudFrontPermissions",
      "Effect": "Allow",
      "Action": [
        "cloudfront:*"
      ],
      "Resource": "*"
    }
    ,
    {
      "Sid": "WAFv2Permissions",
      "Effect": "Allow",
      "Action": [
        "wafv2:*"
      ],
      "Resource": "*"
    }
    ,
    {
      "Sid": "AutoScalingPermissions",
      "Effect": "Allow",
      "Action": [
        "autoscaling:*"
      ],
      "Resource": "*"
    }
    ,
    {
      "Sid": "ElasticLoadBalancingPermissions",
      "Effect": "Allow",
      "Action": [
        "elasticloadbalancing:*"
      ],
      "Resource": "*"
    },
    {
      "Sid": "IAMCreateServiceLinkedRoleForELBandASG",
      "Effect": "Allow",
      "Action": [
        "iam:CreateServiceLinkedRole"
      ],
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "iam:AWSServiceName": [
            "elasticloadbalancing.amazonaws.com",
            "autoscaling.amazonaws.com"
          ]
        }
      }
    }
  ]
}
